<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI溶接支援アプリ - 株式会社アイワエンジニアリング</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
    </script>
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #ea580c;
            --accent-color: #06b6d4;
            --bg-dark: #0f172a;
            --surface-dark: #1e293b;
            --text-light: #f8fafc;
        }

        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a2332 100%);
            color: var(--text-light);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .gradient-border {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color), var(--accent-color));
            padding: 2px;
            border-radius: 12px;
        }

        .gradient-border-content {
            background: var(--surface-dark);
            border-radius: 10px;
            height: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30, 58, 138, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #dc2626 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(234, 88, 12, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(234, 88, 12, 0.4);
        }

        .header-logo {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ai-status {
            background: linear-gradient(90deg, #10b981, #06b6d4);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulse 2s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        .sparks {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .spark {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--secondary-color);
            border-radius: 50%;
            animation: sparkle 2s linear infinite;
        }

        @keyframes sparkle {
            0% { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% { 
                transform: translateY(-100px) scale(0);
                opacity: 0;
            }
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--accent-color);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
            border: 1px solid rgba(6, 182, 212, 0.3);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.1);
        }

        .parameter-input {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .parameter-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .parameter-input.auto-calculated {
            background: rgba(6, 182, 212, 0.2);
            border-color: var(--accent-color);
            color: #06b6d4;
            font-weight: bold;
        }

        select.parameter-input option {
            background: var(--surface-dark);
            color: var(--text-light);
        }

        .process-step {
            position: relative;
            padding-left: 2rem;
        }

        .process-step::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background: var(--accent-color);
        }

        .hidden {
            display: none !important;
        }

        .company-logo {
            max-width: 400px;
            height: auto;
            filter: brightness(1.1);
        }

        .auto-voltage-indicator {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(90deg, #10b981, #06b6d4);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
            animation: pulse 2s ease-in-out infinite alternate;
        }

        .warning-badge {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-left: 8px;
        }

        .gas-indicator {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(90deg, #8b5cf6, #a855f7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-left: 8px;
        }

        .auto-speed-indicator {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(90deg, #ef4444, #dc2626);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-left: 8px;
        }

        .wire-type-indicator {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(90deg, #059669, #10b981);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-left: 8px;
        }

        .flux-wire-indicator {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(90deg, #dc2626, #ef4444);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-left: 8px;
        }

        @media (max-width: 768px) {
            .company-logo {
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="glass-card rounded-none border-0 border-b border-gray-600">
        <div class="container mx-auto px-6 py-4">
            <div class="flex flex-col items-center space-y-3">
                <!-- Company Logo -->
                <div class="flex items-center space-x-4">
                    <svg width="400" height="120" viewBox="0 0 400 120" fill="none" xmlns="http://www.w3.org/2000/svg" class="company-logo">
                        <defs>
                            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#ff6941"/>
                                <stop offset="100%" stop-color="#ea580c"/>
                            </linearGradient>
                            <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#10b981"/>
                                <stop offset="100%" stop-color="#06b6d4"/>
                            </linearGradient>
                            <linearGradient id="grad3" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#3357dc"/>
                                <stop offset="100%" stop-color="#1e3a8a"/>
                            </linearGradient>
                        </defs>
                        <rect x="10" y="30" width="35" height="60" rx="17" fill="url(#grad1)"/>
                        <rect x="55" y="30" width="35" height="60" rx="17" fill="url(#grad2)"/>
                        <rect x="100" y="30" width="35" height="60" rx="17" fill="url(#grad3)"/>
                        <text x="150" y="45" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#f8fafc">株式会社</text>
                        <text x="150" y="68" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#f8fafc">アイワエンジニアリング</text>
                        <text x="150" y="85" font-family="Arial, sans-serif" font-size="12" font-style="italic" fill="#d1d5db">AIWA Engineering</text>
                    </svg>
                </div>
                
                <!-- App Title and AI Status -->
                <div class="text-center">
                    <h1 class="text-2xl md:text-3xl font-bold header-logo mb-2">AI溶接支援アプリ</h1>
                    <div class="flex items-center justify-center space-x-2">
                        <i class="fas fa-robot text-lg"></i>
                        <span class="ai-status font-semibold">🤖 Gemini 2.5 Flash: 稼働中</span>
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="flex flex-wrap justify-center space-x-4 text-sm">
                    <span class="text-gray-300">対応機器:</span>
                    <span class="text-blue-400">ダイヘン WELBEE M-350L</span>
                    <span class="text-gray-400">|</span>
                    <span class="text-blue-400">FD19-VC4 協働ロボット (可搬質量4kg)</span>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Main Menu -->
        <div id="mainMenu" class="space-y-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold mb-4">溶接支援機能選択</h2>
                <p class="text-gray-300 max-w-2xl mx-auto">
                    AI技術を活用した高精度な溶接条件診断システム。教育・研修から実務まで幅広く対応します。
                </p>
            </div>

            <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                <!-- 溶接最適条件診断 -->
                <div class="gradient-border">
                    <div class="gradient-border-content p-8 text-center space-y-6">
                        <div class="sparks">
                            <div class="spark" style="left: 20%; animation-delay: 0s;"></div>
                            <div class="spark" style="left: 50%; animation-delay: 0.5s;"></div>
                            <div class="spark" style="left: 80%; animation-delay: 1s;"></div>
                        </div>
                        <div class="text-6xl text-blue-400 mb-4">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h3 class="text-2xl font-bold">溶接最適条件診断</h3>
                        <p class="text-gray-300">
                            材料・板厚・溶接方法を入力するだけで、AIが最適な溶接条件を自動診断。
                            初心者から上級者まで安心してご利用いただけます。
                        </p>
                        <button id="optimalDiagnosisBtn" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold w-full">
                            <i class="fas fa-magic mr-2"></i>AI診断を開始
                        </button>
                    </div>
                </div>

                <!-- 溶接条件入力シミュレーション -->
                <div class="gradient-border">
                    <div class="gradient-border-content p-8 text-center space-y-6">
                        <div class="text-6xl text-orange-400 mb-4">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <h3 class="text-2xl font-bold">溶接条件入力シミュレーション</h3>
                        <p class="text-gray-300">
                            詳細な溶接条件を入力して品質予測とA/S/B/C/D評価を実施。
                            設定条件の妥当性チェックと改善提案を行います。
                        </p>
                        <button id="inputSimulationBtn" class="btn-secondary text-white px-8 py-3 rounded-lg font-semibold w-full">
                            <i class="fas fa-calculator mr-2"></i>詳細シミュレーション
                        </button>
                    </div>
                </div>
            </div>

            <!-- 免責事項 -->
            <div class="glass-card p-6 mt-12 max-w-4xl mx-auto">
                <div class="text-center">
                    <h4 class="text-lg font-semibold mb-4 text-yellow-400">
                        <i class="fas fa-exclamation-triangle mr-2"></i>重要なご注意
                    </h4>
                    <div class="text-sm text-gray-300 space-y-2">
                        <p>
                            本アプリケーションは、AI技術を活用した溶接条件の参考情報提供を目的としており、
                            溶接作業の結果や品質について保証するものではございません。
                        </p>
                        <p>
                            実際の溶接作業においては、必ず現場での試験溶接および品質確認を実施し、
                            適切な技能を有する作業者による最終判断のもとで作業を行ってください。
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 溶接最適条件診断画面 -->
        <div id="optimalDiagnosis" class="hidden space-y-8">
            <div class="flex items-center justify-between">
                <h2 class="text-3xl font-bold">溶接最適条件診断</h2>
                <button class="back-btn text-blue-400 hover:text-blue-300">
                    <i class="fas fa-arrow-left mr-2"></i>メニューに戻る
                </button>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- 入力パネル -->
                <div class="glass-card p-6 space-y-6">
                    <h3 class="text-xl font-bold mb-4">溶接条件入力</h3>
                    
                    <!-- 母材選択 -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">母材</label>
                        <select id="material" class="parameter-input w-full p-3 rounded-lg">
                            <option value="SS400">SS400 (一般構造用圧延鋼材)</option>
                            <option value="SM490">SM490 (溶接構造用圧延鋼材)</option>
                            <option value="SUS304">SUS304 (オーステナイト系ステンレス鋼)</option>
                            <option value="SUS316L">SUS316L (低炭素ステンレス鋼)</option>
                            <option value="SUS430">SUS430 (フェライト系ステンレス鋼)</option>
                        </select>
                    </div>

                    <!-- シールドガス選択 -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">
                            シールドガス
                            <span class="gas-indicator">
                                💨 ガス種類
                            </span>
                        </label>
                        <select id="shieldGas" class="parameter-input w-full p-3 rounded-lg">
                            <option value="CO2">CO2 (炭酸ガス) - 高溶け込み・経済的</option>
                            <option value="MAG_Ar80CO2_20">MAG (Ar80%+CO2 20%) - 低スパッタ・高品質</option>
                            <option value="MAG_Ar75CO2_25">MAG (Ar75%+CO2 25%) - バランス型</option>
                        </select>
                    </div>

                    <!-- 板厚設定 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">板厚1 (mm)</label>
                            <input type="number" id="thickness1" class="parameter-input w-full p-3 rounded-lg" 
                                   min="0.5" max="25" step="0.1" value="6.0">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">板厚2 (mm)</label>
                            <input type="number" id="thickness2" class="parameter-input w-full p-3 rounded-lg" 
                                   min="0.5" max="25" step="0.1" value="6.0">
                        </div>
                    </div>

                    <!-- 溶接方法選択 -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">溶接方法</label>
                        <select id="weldingMethod" class="parameter-input w-full p-3 rounded-lg">
                            <option value="butt">突き合わせ溶接</option>
                            <option value="fillet">隅肉溶接</option>
                        </select>
                    </div>

                    <!-- 開先設定 -->
                    <div id="grooveSection">
                        <label class="block text-sm font-semibold mb-2">開先の有無</label>
                        <select id="grooveType" class="parameter-input w-full p-3 rounded-lg mb-4">
                            <option value="none">開先なし</option>
                            <option value="v-groove">V型開先</option>
                            <option value="x-groove">X型開先（両面）</option>
                            <option value="u-groove">U型開先（深溝型）</option>
                            <option value="bevel">ベベル加工</option>
                            <option value="j-groove">J型開先</option>
                        </select>

                        <!-- 開先詳細設定 -->
                        <div id="grooveDetails" class="hidden space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">開先角度 (度)</label>
                                    <input type="number" id="grooveAngle" class="parameter-input w-full p-3 rounded-lg" 
                                           min="15" max="80" step="5" value="60">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">開先幅 (mm)</label>
                                    <input type="number" id="grooveWidth" class="parameter-input w-full p-3 rounded-lg" 
                                           min="0" max="5" step="0.1" value="2.0">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">開先深さ (mm)</label>
                                <select id="grooveDepth" class="parameter-input w-full p-3 rounded-lg">
                                    <option value="unknown">不明</option>
                                    <option value="3.0">3.0mm</option>
                                    <option value="4.5">4.5mm</option>
                                    <option value="6.0">6.0mm</option>
                                    <option value="7.5">7.5mm</option>
                                    <option value="9.0">9.0mm</option>
                                    <option value="12.0">12.0mm</option>
                                    <option value="15.0">15.0mm</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ワイヤ選択 -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">
                            溶接ワイヤ
                            <span class="wire-type-indicator">
                                🔄 材質連動
                            </span>
                        </label>
                        <select id="wireSize" class="parameter-input w-full p-3 rounded-lg">
                            <!-- 動的に更新される -->
                        </select>
                    </div>

                    <!-- 脚長・のど厚設定（隅肉溶接時のみ表示） -->
                    <div id="filletSettings" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">脚長 (mm)</label>
                                <select id="legLength" class="parameter-input w-full p-3 rounded-lg">
                                    <option value="unknown">不明</option>
                                    <option value="3">3mm</option>
                                    <option value="4">4mm</option>
                                    <option value="5">5mm</option>
                                    <option value="6">6mm</option>
                                    <option value="7">7mm</option>
                                    <option value="8">8mm</option>
                                    <option value="10">10mm</option>
                                    <option value="12">12mm</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">のど厚 (mm)</label>
                                <select id="throatThickness" class="parameter-input w-full p-3 rounded-lg">
                                    <option value="unknown">不明</option>
                                    <option value="2.1">2.1mm</option>
                                    <option value="2.8">2.8mm</option>
                                    <option value="3.5">3.5mm</option>
                                    <option value="4.2">4.2mm</option>
                                    <option value="4.9">4.9mm</option>
                                    <option value="5.6">5.6mm</option>
                                    <option value="7.0">7.0mm</option>
                                    <option value="8.4">8.4mm</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 溶接距離 -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">溶接距離 (mm)</label>
                        <input type="number" id="weldingLength" class="parameter-input w-full p-3 rounded-lg" 
                               min="10" max="10000" step="10" value="100">
                    </div>

                    <!-- 溶接優先度選択 -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">溶接重視項目</label>
                        <select id="weldingPriority" class="parameter-input w-full p-3 rounded-lg">
                            <option value="unknown">不明</option>
                            <option value="penetration">溶け込み重視</option>
                            <option value="appearance">見た目重視</option>
                            <option value="speed">速度重視</option>
                        </select>
                    </div>

                    <!-- AI診断ボタン -->
                    <button id="aiDiagnosisBtn" class="btn-primary text-white px-6 py-4 rounded-lg font-semibold w-full">
                        <i class="fas fa-magic mr-2"></i>AI診断開始
                    </button>
                </div>

                <!-- 結果表示パネル -->
                <div class="glass-card p-6">
                    <h3 class="text-xl font-bold mb-4">診断結果</h3>
                    <div id="diagnosisResult" class="text-center text-gray-400 py-12">
                        <i class="fas fa-robot text-4xl mb-4 opacity-50"></i>
                        <p>条件を入力してAI診断を実行してください</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 溶接条件入力シミュレーション画面 -->
        <div id="inputSimulation" class="hidden space-y-8">
            <div class="flex items-center justify-between">
                <h2 class="text-3xl font-bold">溶接条件入力シミュレーション</h2>
                <button class="back-btn text-blue-400 hover:text-blue-300">
                    <i class="fas fa-arrow-left mr-2"></i>メニューに戻る
                </button>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- 詳細入力パネル -->
                <div class="glass-card p-6 space-y-6">
                    <h3 class="text-xl font-bold mb-4">詳細溶接条件入力</h3>
                    
                    <!-- 母材選択 -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">母材</label>
                        <select id="simMaterial" class="parameter-input w-full p-3 rounded-lg">
                            <option value="SS400">SS400 (一般構造用圧延鋼材)</option>
                            <option value="SM490">SM490 (溶接構造用圧延鋼材)</option>
                            <option value="SUS304">SUS304 (オーステナイト系ステンレス鋼)</option>
                            <option value="SUS316L">SUS316L (低炭素ステンレス鋼)</option>
                            <option value="SUS430">SUS430 (フェライト系ステンレス鋼)</option>
                        </select>
                    </div>

                    <!-- シールドガス -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">
                            シールドガス
                            <span class="gas-indicator">
                                💨 ガス補正
                            </span>
                        </label>
                        <select id="simShieldGas" class="parameter-input w-full p-3 rounded-lg">
                            <option value="CO2">CO2 (炭酸ガス)</option>
                            <option value="MAG_Ar80CO2_20">MAG (Ar80%+CO2 20%)</option>
                            <option value="MAG_Ar75CO2_25">MAG (Ar75%+CO2 25%)</option>
                        </select>
                    </div>

                    <!-- 板厚設定 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">板厚1 (mm)</label>
                            <input type="number" id="simThickness1" class="parameter-input w-full p-3 rounded-lg" 
                                   min="0.5" max="25" step="0.1" value="6.0">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">板厚2 (mm)</label>
                            <input type="number" id="simThickness2" class="parameter-input w-full p-3 rounded-lg" 
                                   min="0.5" max="25" step="0.1" value="6.0">
                        </div>
                    </div>

                    <!-- 溶接方法選択 -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">溶接方法</label>
                        <select id="simWeldingMethod" class="parameter-input w-full p-3 rounded-lg">
                            <option value="butt">突き合わせ溶接</option>
                            <option value="fillet">隅肉溶接</option>
                        </select>
                    </div>

                    <!-- 開先設定 -->
                    <div id="simGrooveSection">
                        <label class="block text-sm font-semibold mb-2">開先の有無</label>
                        <select id="simGrooveType" class="parameter-input w-full p-3 rounded-lg mb-4">
                            <option value="none">開先なし</option>
                            <option value="v-groove">V型開先</option>
                            <option value="x-groove">X型開先（両面）</option>
                            <option value="u-groove">U型開先（深溝型）</option>
                            <option value="bevel">ベベル加工</option>
                            <option value="j-groove">J型開先</option>
                        </select>

                        <!-- 開先詳細設定 -->
                        <div id="simGrooveDetails" class="hidden space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">開先角度 (度)</label>
                                    <input type="number" id="simGrooveAngle" class="parameter-input w-full p-3 rounded-lg" 
                                           min="15" max="80" step="5" value="60">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">開先幅 (mm)</label>
                                    <input type="number" id="simGrooveWidth" class="parameter-input w-full p-3 rounded-lg" 
                                           min="0" max="5" step="0.1" value="2.0">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">開先深さ (mm)</label>
                                <select id="simGrooveDepth" class="parameter-input w-full p-3 rounded-lg">
                                    <option value="unknown">不明</option>
                                    <option value="3.0">3.0mm</option>
                                    <option value="4.5">4.5mm</option>
                                    <option value="6.0">6.0mm</option>
                                    <option value="7.5">7.5mm</option>
                                    <option value="9.0">9.0mm</option>
                                    <option value="12.0">12.0mm</option>
                                    <option value="15.0">15.0mm</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 脚長・のど厚設定（隅肉溶接時のみ表示） -->
                    <div id="simFilletSettings" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">脚長 (mm)</label>
                                <select id="simLegLength" class="parameter-input w-full p-3 rounded-lg">
                                    <option value="unknown">不明</option>
                                    <option value="3">3mm</option>
                                    <option value="4">4mm</option>
                                    <option value="5">5mm</option>
                                    <option value="6">6mm</option>
                                    <option value="7">7mm</option>
                                    <option value="8">8mm</option>
                                    <option value="10">10mm</option>
                                    <option value="12">12mm</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">のど厚 (mm)</label>
                                <select id="simThroatThickness" class="parameter-input w-full p-3 rounded-lg">
                                    <option value="unknown">不明</option>
                                    <option value="2.1">2.1mm</option>
                                    <option value="2.8">2.8mm</option>
                                    <option value="3.5">3.5mm</option>
                                    <option value="4.2">4.2mm</option>
                                    <option value="4.9">4.9mm</option>
                                    <option value="5.6">5.6mm</option>
                                    <option value="7.0">7.0mm</option>
                                    <option value="8.4">8.4mm</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 溶接距離 -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">溶接距離 (mm)</label>
                        <input type="number" id="simWeldingLength" class="parameter-input w-full p-3 rounded-lg" 
                               min="10" max="10000" step="10" value="100">
                    </div>

                    <!-- ワイヤ選択 -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">
                            溶接ワイヤ
                            <span class="wire-type-indicator">
                                🔄 材質連動
                            </span>
                        </label>
                        <select id="simWireSize" class="parameter-input w-full p-3 rounded-lg">
                            <!-- 動的に更新される -->
                        </select>
                    </div>

                    <!-- 溶接電流・電圧（一元機能付き） -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">溶接電流 (A)</label>
                            <input type="number" id="weldingCurrent" class="parameter-input w-full p-3 rounded-lg" 
                                   min="30" max="350" step="5" value="150">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">
                                溶接電圧 (V)
                                <span class="auto-voltage-indicator">
                                    <i class="fas fa-magic mr-1"></i>一元自動
                                </span>
                            </label>
                            <input type="number" id="weldingVoltage" class="parameter-input auto-calculated w-full p-3 rounded-lg" 
                                   readonly value="19.0">
                        </div>
                    </div>

                    <!-- ワイヤ送給速度削除、代わりに注意表示 -->
                    <div class="p-3 bg-blue-900/30 rounded-lg">
                        <p class="text-sm text-blue-300">
                            <i class="fas fa-info-circle mr-2"></i>
                            <span class="auto-speed-indicator">
                                🔄 一元自動
                            </span>
                            ワイヤ送給速度は電流値に基づいて自動計算されます（WELBEE M-350L一元機能）
                        </p>
                    </div>

                    <!-- プリフロー・アフターフロー -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">プリフロー時間 (秒)</label>
                            <input type="number" id="preFlow" class="parameter-input w-full p-3 rounded-lg" 
                                   min="0" max="10" step="0.1" value="0.1">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">アフターフロー時間 (秒)</label>
                            <input type="number" id="afterFlow" class="parameter-input w-full p-3 rounded-lg" 
                                   min="0" max="10" step="0.1" value="0.4">
                        </div>
                    </div>

                    <!-- ウィービング設定（注意表示付き） -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">
                            ウィービング設定
                            <span class="warning-badge">
                                ⚠️ ロボット制御時のみ
                            </span>
                        </label>
                        <div class="space-y-3">
                            <select id="weavingEnabled" class="parameter-input w-full p-3 rounded-lg">
                                <option value="false">ウィービングなし</option>
                                <option value="true">ウィービングあり（FD19-VC4制御）</option>
                            </select>
                            <div id="weavingSettings" class="hidden space-y-3">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">ウィービング幅 (mm)</label>
                                        <input type="number" id="weavingWidth" class="parameter-input w-full p-3 rounded-lg" 
                                               min="0.5" max="10" step="0.5" value="3.0">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">ウィービング周波数 (Hz)</label>
                                        <input type="number" id="weavingFrequency" class="parameter-input w-full p-3 rounded-lg" 
                                               min="0.1" max="5.0" step="0.1" value="1.0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- シミュレーションボタン -->
                    <button id="detailedSimBtn" class="btn-secondary text-white px-6 py-4 rounded-lg font-semibold w-full">
                        <i class="fas fa-calculator mr-2"></i>詳細シミュレーション実行
                    </button>
                </div>

                <!-- シミュレーション結果 -->
                <div class="glass-card p-6">
                    <h3 class="text-xl font-bold mb-4">シミュレーション結果</h3>
                    <div id="simulationResult" class="text-center text-gray-400 py-12">
                        <i class="fas fa-chart-line text-4xl mb-4 opacity-50"></i>
                        <p>条件を入力してシミュレーションを実行してください</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="glass-card rounded-none border-0 border-t border-gray-600 mt-16">
        <div class="container mx-auto px-6 py-8">
            <div class="text-center space-y-4">
                <div class="flex items-center justify-center space-x-2">
                    <i class="fas fa-copyright text-gray-400"></i>
                    <span class="text-gray-300">2025 株式会社アイワエンジニアリング</span>
                </div>
                <div class="text-sm text-gray-400 space-y-2">
                    <p>溶接技術のスペシャリスト - 教育から実務まで幅広くサポート</p>
                    <p>本アプリケーションの利用により生じた損害について、弊社は一切の責任を負いかねます。</p>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        class WeldingAIService {
            constructor() {
                this.API_KEY = 'AIzaSyBivo2r8DpE8DATru1Vy8JuinouvrZwRHk';
                this.genAI = new GoogleGenerativeAI(this.API_KEY);
                this.model = this.genAI.getGenerativeModel({ 
                    model: "gemini-2.5-flash",
                    generationConfig: {
                        temperature: 0.2,
                        topK: 32,
                        topP: 0.9,
                        maxOutputTokens: 8192,
                    }
                });
                console.log('✅ Gemini 2.5 Flash初期化完了');
            }

            async diagnoseWeldingConditions(conditions) {
                const prompt = this.createOptimalDiagnosisPrompt(conditions);
                try {
                    const result = await this.model.generateContent(prompt);
                    const response = await result.response;
                    return response.text();
                } catch (error) {
                    console.error('AI診断エラー:', error);
                    throw new Error(`Gemini 2.5 Flash診断に失敗しました: ${error.message}`);
                }
            }

            async simulateWeldingConditions(conditions) {
                const prompt = this.createSimulationPrompt(conditions);
                try {
                    const result = await this.model.generateContent(prompt);
                    const response = await result.response;
                    return response.text();
                } catch (error) {
                    console.error('シミュレーションエラー:', error);
                    throw new Error(`Gemini 2.5 Flashシミュレーションに失敗しました: ${error.message}`);
                }
            }

            createOptimalDiagnosisPrompt(conditions) {
                return `
【ダイヘンWELBEE M-350L & FD19-VC4 高精度溶接診断】

あなたは溶接工学の世界的専門家として、最高精度の診断をお願いします。

■ 入力条件:
- 母材: ${conditions.material}
- シールドガス: ${conditions.shieldGas}
- 板厚1: ${conditions.thickness1}mm
- 板厚2: ${conditions.thickness2}mm  
- 溶接方法: ${conditions.weldingMethod}
- 開先タイプ: ${conditions.grooveType}
- 開先角度: ${conditions.grooveAngle}度
- 開先幅: ${conditions.grooveWidth}mm
- 開先深さ: ${conditions.grooveDepth}
- 溶接ワイヤ: ${conditions.wireSize}
- 脚長: ${conditions.legLength}
- のど厚: ${conditions.throatThickness}
- 溶接距離: ${conditions.weldingLength}mm
- 重視項目: ${conditions.weldingPriority}

■ ワイヤ種類と材質対応:
【SS系材料 (SS400, SM490)】
- ソリッドワイヤ: YGW11 (JIS Z 3312) - 経済的、一般的
- フラックスワイヤ: YFW-C50DR (JIS Z 3313) - 高溶込み、屋外作業可

【ステンレス系材料 (SUS304, SUS316L, SUS430)】
- フラックスワイヤのみ使用可能: YF308L, YF316L (JIS Z 3323)
- ※ステンレスはフラックスワイヤ必須（耐食性確保のため）

■ シールドガス特性:
- CO2: 高溶け込み、経済的、スパッタ多、溶接電圧+0.5V補正
- MAG(Ar80%+CO2 20%): 低スパッタ、高品質、溶接電圧-0.5V補正、アーク安定
- MAG(Ar75%+CO2 25%): バランス型、中程度スパッタ、基準電圧使用

■ 機器仕様:
- WELBEE M-350L: 定格出力電流30-350A、電圧12-38V、一元機能搭載、パルス機能なし
- FD19-VC4: 協働ロボット、可搬質量4kg、軌跡精度±0.1mm、ウィービング制御対応

■ 診断回答形式（必須・この順序で回答）:
【溶接条件】（必ず最初に記載）
・溶接電流: ○○A
・溶接電圧: ○○V（一元設定+ガス補正）
・ワイヤ送給速度: ○○m/min（一元自動計算）
・溶接速度: ○○cm/min
・推奨パス数: ○パス
・推奨ワイヤ: ○○（材質対応）
・プリフロー時間: ○○秒
・アフターフロー時間: ○○秒
・ガス流量: ○○L/min
・ウィービング幅: ○○mm（ロボット制御時）
・ウィービング周波数: ○○Hz（ロボット制御時）
・トーチ角度: ○○度
・進行方向: プッシュ/プル
・アーク特性: ○○（-99～99）

【詳細解説】
（上記条件の技術的根拠と説明）

■ 重要事項:
- 必ず溶接条件を数値で先に示してから解説すること
- 一元機能により電流→電圧→ワイヤ送給速度を自動計算+シールドガス補正
- 板厚・開先・ワイヤ径に基づく最適パス数を判定
- 材質に応じたワイヤ種類を明記（ステンレスはフラックス必須）
- 各パス別の詳細溶接条件を提示
- ウィービング機能は協働ロボット制御時のみ使用可能
- 回答が途中で終了しないよう完全な診断結果を提供

必ず日本語で、数値計算過程を明示し、技術的根拠を詳細に説明してください。
                `;
            }

            createSimulationPrompt(conditions) {
                return `
【ダイヘンWELBEE M-350L 溶接条件評価・採点】

入力された溶接条件を専門的に評価し、A/S/B/C/D判定を行ってください。

■ 入力溶接条件:
- 母材: ${conditions.material}
- シールドガス: ${conditions.shieldGas}
- 板厚1: ${conditions.thickness1}mm
- 板厚2: ${conditions.thickness2}mm
- 溶接方法: ${conditions.weldingMethod}
- 開先タイプ: ${conditions.grooveType}
- 開先角度: ${conditions.grooveAngle}度
- 開先幅: ${conditions.grooveWidth}mm
- 開先深さ: ${conditions.grooveDepth}
- 溶接ワイヤ: ${conditions.wireSize}
- 脚長: ${conditions.legLength}
- のど厚: ${conditions.throatThickness}
- 溶接距離: ${conditions.weldingLength}mm
- 溶接電流: ${conditions.current}A
- 溶接電圧: ${conditions.voltage}V（一元設定自動計算）
- プリフロー時間: ${conditions.preFlow}秒
- アフターフロー時間: ${conditions.afterFlow}秒
- ウィービング: ${conditions.weaving}
- ウィービング幅: ${conditions.weavingWidth}mm
- ウィービング周波数: ${conditions.weavingFrequency}Hz

■ ワイヤ適合性チェック:
【SS系材料】ソリッドワイヤ・フラックスワイヤ両方可
【ステンレス系】フラックスワイヤのみ（耐食性確保必須）

■ 評価回答形式（必須・この順序で回答）:
【評価結果概要】（必ず最初に記載）
・総合評価: ○評価（○○点/100点）
・電流設定: ○○点/20点
・電圧設定: ○○点/20点（ガス補正含む）
・板厚・開先適合性: ○○点/20点
・ワイヤ材質適合性: ○○点/20点
・ガス・時間設定: ○○点/20点

【詳細評価とアドバイス】
（各項目の評価理由と改善提案）

■ 評価項目:
1. 電流設定の妥当性 (20点満点)
2. 電圧設定の妥当性（一元機能+ガス補正） (20点満点) 
3. 板厚・開先条件との適合性 (20点満点)
4. ワイヤ種類と材質の適合性（ステンレス=フラックス必須） (20点満点)
5. ガス流量・時間・種類設定 (20点満点)

■ 評価基準:
- S評価: 95-100点 (完璧)
- A評価: 85-94点 (優秀)
- B評価: 70-84点 (良好)
- C評価: 50-69点 (要改善)
- D評価: 0-49点 (不適切)

■ 重要事項:
- 必ず評価結果を数値で先に示してから解説すること
- 各項目の採点理由と改善提案を具体的に説明
- WELBEE M-350Lの一元設定とシールドガス特性を考慮
- ワイヤ材質適合性を重点評価（ステンレス系の場合）
- 回答が途中で終了しないよう完全な評価結果を提供
- ワイヤ送給速度は一元機能で自動計算されるため評価対象外

必ず日本語で詳細に評価してください。
                `;
            }
        }

        // 一元機能による電圧自動計算クラス（シールドガス補正対応）
        class WeldingCalculator {
            static calculateVoltage(current, wireSize, material, shieldGas) {
                let baseVoltage;
                
                // ワイヤ径別の基本計算（WELBEE M-350L実機データ準拠）
                const wireData = this.parseWireSize(wireSize);
                const diameter = wireData.diameter;
                
                switch(diameter) {
                    case 0.8:
                        baseVoltage = current * 0.14 + 8.0;
                        break;
                    case 0.9:
                        baseVoltage = current * 0.15 + 8.5;
                        break;
                    case 1.0:
                        baseVoltage = current * 0.16 + 9.0;
                        break;
                    case 1.2:
                        baseVoltage = current * 0.17 + 9.5;
                        break;
                    case 1.4:
                        baseVoltage = current * 0.18 + 10.0;
                        break;
                    case 1.6:
                        baseVoltage = current * 0.19 + 10.5;
                        break;
                    default:
                        baseVoltage = current * 0.16 + 9.0;
                }
                
                // 材質補正（実機データ準拠）
                let materialCorrection = 0;
                switch(material) {
                    case 'SS400':
                        materialCorrection = 0;
                        break;
                    case 'SM490':
                        materialCorrection = 0.3;
                        break;
                    case 'SUS304':
                        materialCorrection = -0.8;
                        break;
                    case 'SUS316L':
                        materialCorrection = -0.5;
                        break;
                    case 'SUS430':
                        materialCorrection = -0.6;
                        break;
                    default:
                        materialCorrection = 0;
                }

                // シールドガス補正
                let gasCorrection = 0;
                switch(shieldGas) {
                    case 'CO2':
                        gasCorrection = 0.5;
                        break;
                    case 'MAG_Ar80CO2_20':
                        gasCorrection = -0.5;
                        break;
                    case 'MAG_Ar75CO2_25':
                        gasCorrection = 0;
                        break;
                    default:
                        gasCorrection = 0;
                }
                
                // フラックスワイヤ補正
                let fluxCorrection = 0;
                if (wireData.type === 'flux') {
                    fluxCorrection = -1.0; // フラックスワイヤは電圧を下げる
                }
                
                const finalVoltage = baseVoltage + materialCorrection + gasCorrection + fluxCorrection;
                
                // WELBEE M-350L の電圧範囲制限（12.0-38.0V）
                const limitedVoltage = Math.max(12.0, Math.min(38.0, finalVoltage));
                return Math.round(limitedVoltage * 10) / 10;
            }

            static parseWireSize(wireString) {
                if (wireString.includes('φ')) {
                    const diameter = parseFloat(wireString.match(/φ([\d.]+)/)[1]);
                    const type = wireString.includes('フラックス') ? 'flux' : 'solid';
                    return { diameter, type };
                }
                return { diameter: 1.0, type: 'solid' };
            }
        }

        // ワイヤ選択データベース
        class WireDatabase {
            static getWireOptions(material) {
                switch(material) {
                    case 'SS400':
                    case 'SM490':
                        return [
                            'φ0.8mm ソリッドワイヤ (YGW11)',
                            'φ0.9mm ソリッドワイヤ (YGW11)',
                            'φ1.0mm ソリッドワイヤ (YGW11)',
                            'φ1.2mm ソリッドワイヤ (YGW11)',
                            'φ1.4mm ソリッドワイヤ (YGW11)',
                            'φ1.6mm ソリッドワイヤ (YGW11)',
                            'φ0.8mm フラックスワイヤ (YFW-C50DR)',
                            'φ0.9mm フラックスワイヤ (YFW-C50DR)',
                            'φ1.0mm フラックスワイヤ (YFW-C50DR)',
                            'φ1.2mm フラックスワイヤ (YFW-C50DR)',
                            'φ1.4mm フラックスワイヤ (YFW-C50DR)',
                            'φ1.6mm フラックスワイヤ (YFW-C50DR)'
                        ];
                    case 'SUS304':
                        return [
                            'φ0.8mm フラックスワイヤ (YF308L) ※必須',
                            'φ0.9mm フラックスワイヤ (YF308L) ※必須',
                            'φ1.0mm フラックスワイヤ (YF308L) ※必須',
                            'φ1.2mm フラックスワイヤ (YF308L) ※必須',
                            'φ1.4mm フラックスワイヤ (YF308L) ※必須'
                        ];
                    case 'SUS316L':
                        return [
                            'φ0.8mm フラックスワイヤ (YF316L) ※必須',
                            'φ0.9mm フラックスワイヤ (YF316L) ※必須',
                            'φ1.0mm フラックスワイヤ (YF316L) ※必須',
                            'φ1.2mm フラックスワイヤ (YF316L) ※必須',
                            'φ1.4mm フラックスワイヤ (YF316L) ※必須'
                        ];
                    case 'SUS430':
                        return [
                            'φ0.8mm フラックスワイヤ (YF430) ※必須',
                            'φ0.9mm フラックスワイヤ (YF430) ※必須',
                            'φ1.0mm フラックスワイヤ (YF430) ※必須',
                            'φ1.2mm フラックスワイヤ (YF430) ※必須',
                            'φ1.4mm フラックスワイヤ (YF430) ※必須'
                        ];
                    default:
                        return [
                            'φ1.0mm ソリッドワイヤ (YGW11)'
                        ];
                }
            }
        }

        // グローバルインスタンス
        const weldingAI = new WeldingAIService();

        // DOM要素の取得
        const elements = {
            mainMenu: document.getElementById('mainMenu'),
            optimalDiagnosis: document.getElementById('optimalDiagnosis'),
            inputSimulation: document.getElementById('inputSimulation'),
            optimalDiagnosisBtn: document.getElementById('optimalDiagnosisBtn'),
            inputSimulationBtn: document.getElementById('inputSimulationBtn'),
            aiDiagnosisBtn: document.getElementById('aiDiagnosisBtn'),
            detailedSimBtn: document.getElementById('detailedSimBtn'),
            diagnosisResult: document.getElementById('diagnosisResult'),
            simulationResult: document.getElementById('simulationResult'),
            weldingMethod: document.getElementById('weldingMethod'),
            grooveType: document.getElementById('grooveType'),
            grooveDetails: document.getElementById('grooveDetails'),
            filletSettings: document.getElementById('filletSettings'),
            weavingEnabled: document.getElementById('weavingEnabled'),
            weavingSettings: document.getElementById('weavingSettings'),
            // 診断画面用
            material: document.getElementById('material'),
            wireSize: document.getElementById('wireSize'),
            // シミュレーション用
            weldingCurrent: document.getElementById('weldingCurrent'),
            weldingVoltage: document.getElementById('weldingVoltage'),
            simMaterial: document.getElementById('simMaterial'),
            simWireSize: document.getElementById('simWireSize'),
            simShieldGas: document.getElementById('simShieldGas'),
            simWeldingMethod: document.getElementById('simWeldingMethod'),
            simGrooveType: document.getElementById('simGrooveType'),
            simGrooveDetails: document.getElementById('simGrooveDetails'),
            simFilletSettings: document.getElementById('simFilletSettings')
        };

        // ワイヤ選択肢更新関数
        function updateWireOptions(materialElement, wireElement) {
            const material = materialElement.value;
            const wireOptions = WireDatabase.getWireOptions(material);
            
            wireElement.innerHTML = '';
            wireOptions.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                wireElement.appendChild(optionElement);
            });
            
            // 最初のオプションを選択
            if (wireOptions.length > 0) {
                wireElement.value = wireOptions[Math.floor(wireOptions.length / 2)]; // 中間の径を選択
            }
        }

        // 一元機能: 電流変更時の電圧自動計算（シールドガス対応）
        function updateAutoVoltage() {
            const current = parseFloat(elements.weldingCurrent.value) || 150;
            const wireSize = elements.simWireSize.value || 'φ1.0mm ソリッドワイヤ (YGW11)';
            const material = elements.simMaterial.value || 'SS400';
            const shieldGas = elements.simShieldGas.value || 'CO2';
            
            const autoVoltage = WeldingCalculator.calculateVoltage(current, wireSize, material, shieldGas);
            elements.weldingVoltage.value = autoVoltage;
            
            // 視覚的フィードバック
            elements.weldingVoltage.style.transform = 'scale(1.05)';
            setTimeout(() => {
                elements.weldingVoltage.style.transform = 'scale(1.0)';
            }, 200);
        }

        // イベントリスナーの設定
        function initializeEventListeners() {
            // メニューボタン
            elements.optimalDiagnosisBtn?.addEventListener('click', showOptimalDiagnosis);
            elements.inputSimulationBtn?.addEventListener('click', showInputSimulation);
            
            // AI診断・シミュレーションボタン
            elements.aiDiagnosisBtn?.addEventListener('click', runAIDiagnosis);
            elements.detailedSimBtn?.addEventListener('click', runDetailedSimulation);
            
            // 戻るボタン
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.addEventListener('click', showMainMenu);
            });

            // 条件変更時の表示切替（診断画面）
            elements.weldingMethod?.addEventListener('change', toggleFilletSettings);
            elements.grooveType?.addEventListener('change', toggleGrooveDetails);
            elements.weavingEnabled?.addEventListener('change', toggleWeavingSettings);

            // 条件変更時の表示切替（シミュレーション画面）
            elements.simWeldingMethod?.addEventListener('change', toggleSimFilletSettings);
            elements.simGrooveType?.addEventListener('change', toggleSimGrooveDetails);

            // ワイヤ選択肢更新（診断画面）
            elements.material?.addEventListener('change', () => {
                updateWireOptions(elements.material, elements.wireSize);
            });

            // ワイヤ選択肢更新（シミュレーション画面）
            elements.simMaterial?.addEventListener('change', () => {
                updateWireOptions(elements.simMaterial, elements.simWireSize);
                updateAutoVoltage();
            });

            // 一元機能: 電流・ワイヤ径・材質・ガス変更時の電圧自動計算
            elements.weldingCurrent?.addEventListener('input', updateAutoVoltage);
            elements.simWireSize?.addEventListener('change', updateAutoVoltage);
            elements.simShieldGas?.addEventListener('change', updateAutoVoltage);
        }

        // 画面切替関数
        function showMainMenu() {
            elements.mainMenu.classList.remove('hidden');
            elements.optimalDiagnosis.classList.add('hidden');
            elements.inputSimulation.classList.add('hidden');
        }

        function showOptimalDiagnosis() {
            elements.mainMenu.classList.add('hidden');
            elements.optimalDiagnosis.classList.remove('hidden');
            elements.inputSimulation.classList.add('hidden');
            // 診断画面表示時にワイヤ選択肢を更新
            setTimeout(() => {
                updateWireOptions(elements.material, elements.wireSize);
                toggleFilletSettings();
                toggleGrooveDetails();
            }, 100);
        }

        function showInputSimulation() {
            elements.mainMenu.classList.add('hidden');
            elements.optimalDiagnosis.classList.add('hidden');
            elements.inputSimulation.classList.remove('hidden');
            // シミュレーション画面表示時に表示切替とワイヤ選択肢・電圧を更新
            setTimeout(() => {
                updateWireOptions(elements.simMaterial, elements.simWireSize);
                toggleSimFilletSettings();
                toggleSimGrooveDetails();
                updateAutoVoltage();
            }, 100);
        }

        // 表示切替関数（診断画面用）
        function toggleFilletSettings() {
            const isFilletWelding = elements.weldingMethod.value === 'fillet';
            if (elements.filletSettings) {
                elements.filletSettings.classList.toggle('hidden', !isFilletWelding);
            }
        }

        function toggleGrooveDetails() {
            const hasGroove = elements.grooveType.value !== 'none';
            if (elements.grooveDetails) {
                elements.grooveDetails.classList.toggle('hidden', !hasGroove);
            }
        }

        function toggleWeavingSettings() {
            const weavingEnabled = elements.weavingEnabled.value === 'true';
            if (elements.weavingSettings) {
                elements.weavingSettings.classList.toggle('hidden', !weavingEnabled);
            }
        }

        // 表示切替関数（シミュレーション画面用）
        function toggleSimFilletSettings() {
            const isFilletWelding = elements.simWeldingMethod?.value === 'fillet';
            if (elements.simFilletSettings) {
                elements.simFilletSettings.classList.toggle('hidden', !isFilletWelding);
            }
        }

        function toggleSimGrooveDetails() {
            const hasGroove = elements.simGrooveType?.value !== 'none';
            if (elements.simGrooveDetails) {
                elements.simGrooveDetails.classList.toggle('hidden', !hasGroove);
            }
        }

        // AI診断実行
        async function runAIDiagnosis() {
            const button = elements.aiDiagnosisBtn;
            const resultDiv = elements.diagnosisResult;
            
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>🤖 Gemini 2.5 Flash 解析中...';
            
            try {
                const conditions = collectOptimalConditions();
                const result = await weldingAI.diagnoseWeldingConditions(conditions);
                displayDiagnosisResult(result);
            } catch (error) {
                console.error('AI診断エラー:', error);
                resultDiv.innerHTML = `
                    <div class="text-red-400 space-y-4">
                        <i class="fas fa-exclamation-triangle text-4xl"></i>
                        <p class="text-lg font-semibold">🚨 Gemini 2.5 Flash エラー</p>
                        <p class="text-sm">${error.message}</p>
                        <p class="text-xs text-gray-400">APIキー確認済み: ${weldingAI.API_KEY ? '✅' : '❌'}</p>
                        <button onclick="location.reload()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-redo mr-1"></i>再試行
                        </button>
                    </div>
                `;
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-magic mr-2"></i>AI診断開始';
            }
        }

        // 詳細シミュレーション実行
        async function runDetailedSimulation() {
            const button = elements.detailedSimBtn;
            const resultDiv = elements.simulationResult;
            
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner inline-block mr-2"></div>🔍 Gemini 2.5 Flash 解析中...';
            
            try {
                const conditions = collectSimulationConditions();
                const result = await weldingAI.simulateWeldingConditions(conditions);
                displaySimulationResult(result);
            } catch (error) {
                console.error('シミュレーションエラー:', error);
                resultDiv.innerHTML = `
                    <div class="text-red-400 space-y-4">
                        <i class="fas fa-exclamation-triangle text-4xl"></i>
                        <p class="text-lg font-semibold">🚨 Gemini 2.5 Flash エラー</p>
                        <p class="text-sm">${error.message}</p>
                        <p class="text-xs text-gray-400">APIキー確認済み: ${weldingAI.API_KEY ? '✅' : '❌'}</p>
                        <button onclick="location.reload()" class="btn-secondary text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-redo mr-1"></i>再試行
                        </button>
                    </div>
                `;
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-calculator mr-2"></i>詳細シミュレーション実行';
            }
        }

        // 条件収集関数
        function collectOptimalConditions() {
            return {
                material: document.getElementById('material')?.value || 'SS400',
                shieldGas: document.getElementById('shieldGas')?.value || 'CO2',
                thickness1: parseFloat(document.getElementById('thickness1')?.value || '6'),
                thickness2: parseFloat(document.getElementById('thickness2')?.value || '6'),
                weldingMethod: document.getElementById('weldingMethod')?.value || 'butt',
                grooveType: document.getElementById('grooveType')?.value || 'none',
                grooveAngle: parseFloat(document.getElementById('grooveAngle')?.value || '60'),
                grooveWidth: parseFloat(document.getElementById('grooveWidth')?.value || '2.0'),
                grooveDepth: document.getElementById('grooveDepth')?.value || 'unknown',
                wireSize: document.getElementById('wireSize')?.value || 'φ1.0mm ソリッドワイヤ (YGW11)',
                legLength: document.getElementById('legLength')?.value || 'unknown',
                throatThickness: document.getElementById('throatThickness')?.value || 'unknown',
                weldingLength: parseFloat(document.getElementById('weldingLength')?.value || '100'),
                weldingPriority: document.getElementById('weldingPriority')?.value || 'unknown'
            };
        }

        // シミュレーション条件収集関数
        function collectSimulationConditions() {
            return {
                material: elements.simMaterial?.value || 'SS400',
                shieldGas: elements.simShieldGas?.value || 'CO2',
                thickness1: parseFloat(document.getElementById('simThickness1')?.value || '6'),
                thickness2: parseFloat(document.getElementById('simThickness2')?.value || '6'),
                weldingMethod: elements.simWeldingMethod?.value || 'butt',
                grooveType: elements.simGrooveType?.value || 'none',
                grooveAngle: parseFloat(document.getElementById('simGrooveAngle')?.value || '60'),
                grooveWidth: parseFloat(document.getElementById('simGrooveWidth')?.value || '2.0'),
                grooveDepth: document.getElementById('simGrooveDepth')?.value || 'unknown',
                wireSize: elements.simWireSize?.value || 'φ1.0mm ソリッドワイヤ (YGW11)',
                legLength: document.getElementById('simLegLength')?.value || 'unknown',
                throatThickness: document.getElementById('simThroatThickness')?.value || 'unknown',
                weldingLength: parseFloat(document.getElementById('simWeldingLength')?.value || '100'),
                current: parseFloat(elements.weldingCurrent?.value || '150'),
                voltage: parseFloat(elements.weldingVoltage?.value || '19'),
                preFlow: parseFloat(document.getElementById('preFlow')?.value || '0.1'),
                afterFlow: parseFloat(document.getElementById('afterFlow')?.value || '0.4'),
                weaving: document.getElementById('weavingEnabled')?.value === 'true',
                weavingWidth: parseFloat(document.getElementById('weavingWidth')?.value || '3.0'),
                weavingFrequency: parseFloat(document.getElementById('weavingFrequency')?.value || '1.0')
            };
        }

        // 結果表示関数
        function displayDiagnosisResult(result) {
            elements.diagnosisResult.innerHTML = `
                <div class="result-card p-6 rounded-lg space-y-4 text-left">
                    <div class="flex items-center space-x-2 mb-4">
                        <i class="fas fa-brain text-blue-400"></i>
                        <h4 class="text-lg font-bold">🤖 Gemini 2.5 Flash AI診断結果</h4>
                    </div>
                    <div class="text-sm leading-relaxed whitespace-pre-wrap">${result}</div>
                    <div class="mt-6 p-4 bg-blue-900/30 rounded-lg">
                        <p class="text-xs text-blue-300">
                            <i class="fas fa-info-circle mr-1"></i>
                            この診断結果は参考情報です。実際の溶接時は現場での試験溶接を実施してください。
                        </p>
                    </div>
                </div>
            `;
        }

        function displaySimulationResult(result) {
            elements.simulationResult.innerHTML = `
                <div class="result-card p-6 rounded-lg space-y-4 text-left">
                    <div class="flex items-center space-x-2 mb-4">
                        <i class="fas fa-chart-line text-orange-400"></i>
                        <h4 class="text-lg font-bold">📊 溶接条件評価結果</h4>
                    </div>
                    <div class="text-sm leading-relaxed whitespace-pre-wrap">${result}</div>
                    <div class="mt-6 p-4 bg-orange-900/30 rounded-lg">
                        <p class="text-xs text-orange-300">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            評価結果は入力条件に基づく分析です。実際の品質は現場条件により変動する場合があります。
                        </p>
                    </div>
                </div>
            `;
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM読み込み完了 - 初期化開始');
            console.log('🔑 APIキー設定確認:', weldingAI.API_KEY ? '✅ 正常' : '❌ 未設定');
            
            initializeEventListeners();
            
            // 初期表示設定
            toggleFilletSettings();
            toggleGrooveDetails();
            toggleWeavingSettings();
            
            // 初期ワイヤ選択肢設定
            updateWireOptions(elements.material, elements.wireSize);
            updateWireOptions(elements.simMaterial, elements.simWireSize);
            
            // 初期電圧計算
            updateAutoVoltage();
            
            console.log('✅ AI溶接支援アプリ完全初期化完了 - 完全版');
            console.log('🔧 機能チェック:');
            console.log('  - シミュレーション画面項目修正: ✅ 完了');
            console.log('  - ステンレス用フラックスワイヤ: ✅ 実装済み');
            console.log('  - SS系・ステンレス系ワイヤ選択: ✅ 実装済み');
            console.log('  - ヘッダースクロール対応: ✅ 完了');
            console.log('  - Gemini 2.5 Flash完全対応: ✅ 確認済み');
        });

    </script>
</body>
</html>
